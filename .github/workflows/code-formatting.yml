name: Code Formatting

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: ['main', 'develop', 'claude/**']
  pull_request:
    branches: ['main', 'develop']

jobs:
  check-formatting:
    name: Check Code Formatting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python formatting tools
        run: |
          python -m pip install --upgrade pip
          pip install black>=24.1.0 sqlfluff>=3.0.0

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

      - name: Check Python formatting with Black
        id: black
        run: |
          echo "::group::Python Formatting Check"
          if black --check --diff src/python/ tests/python/; then
            echo "✓ Python code is properly formatted"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "::error::Python code is not properly formatted"
            echo "result=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "::endgroup::"
        continue-on-error: true

      - name: Check PowerShell formatting
        id: powershell
        shell: pwsh
        run: |
          Write-Host "::group::PowerShell Formatting Check"

          $result = & ./scripts/Format-PowerShellCode.ps1 -Check
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Write-Host "✓ PowerShell code is properly formatted"
            "result=success" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "::error::PowerShell code is not properly formatted"
            "result=failure" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

          Write-Host "::endgroup::"
          exit $exitCode
        continue-on-error: true

      - name: Check SQL formatting with SQLFluff
        id: sqlfluff
        run: |
          echo "::group::SQL Formatting Check"
          if [ -d "src/sql" ] && find src/sql -name "*.sql" -type f | grep -q .; then
            # Run sqlfluff lint and capture output
            LINT_OUTPUT=$(sqlfluff lint --config .sqlfluffrc src/sql/ --format github-annotation 2>&1) || true
            echo "$LINT_OUTPUT"

            # Check if there are any fixable violations
            if echo "$LINT_OUTPUT" | grep -q "fixable linting violations found"; then
              echo "::error::SQL code has fixable formatting violations"
              echo "result=failure" >> $GITHUB_OUTPUT
              exit 1
            else
              # No fixable violations - success (unfixable violations are acceptable)
              if echo "$LINT_OUTPUT" | grep -q "unfixable linting violations"; then
                echo "::warning::SQL code has unfixable linting violations (acceptable)"
              fi
              echo "✓ SQL code formatting is acceptable (no fixable violations)"
              echo "result=success" >> $GITHUB_OUTPUT
            fi
          else
            echo "⚠ No SQL files found to check"
            echo "result=skipped" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"
        continue-on-error: true

      - name: Check Documentation Paths
        id: docpaths
        shell: pwsh
        run: |
          Write-Host "::group::Documentation Path Check"

          $result = & ./scripts/Check-DocumentationPaths.ps1
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Write-Host "✓ Documentation uses placeholders correctly"
            "result=success" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          } else {
            Write-Host "::error::Documentation contains hardcoded paths"
            "result=failure" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

          Write-Host "::endgroup::"
          exit $exitCode
        continue-on-error: true

      - name: Report results
        if: always()
        run: |
          echo "# Code Formatting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.black.outputs.result }}" == "success" ]; then
            echo "| Python (Black) | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Python (Black) | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.powershell.outputs.result }}" == "success" ]; then
            echo "| PowerShell | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| PowerShell | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.sqlfluff.outputs.result }}" == "success" ]; then
            echo "| SQL (SQLFluff) | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.sqlfluff.outputs.result }}" == "skipped" ]; then
            echo "| SQL (SQLFluff) | ⚠️ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SQL (SQLFluff) | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.docpaths.outputs.result }}" == "success" ]; then
            echo "| Documentation Paths | ✅ Pass |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Documentation Paths | ❌ Fail |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To fix formatting issues, run:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "./scripts/format-all.sh" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: always()
        run: |
          FAILED=false

          # Check Python formatting (strict)
          if [ "${{ steps.black.outputs.result }}" == "failure" ]; then
            echo "::error::Python formatting check failed"
            FAILED=true
          fi

          # Check SQL formatting (strict)
          if [ "${{ steps.sqlfluff.outputs.result }}" == "failure" ]; then
            echo "::error::SQL formatting check failed"
            FAILED=true
          fi

          # Check PowerShell formatting (warning only if no result)
          if [ "${{ steps.powershell.outputs.result }}" == "failure" ]; then
            echo "::warning::PowerShell formatting check failed"
            # Uncomment to make PowerShell checks strict:
            # FAILED=true
          fi

          # Check Documentation Paths (strict)
          if [ "${{ steps.docpaths.outputs.result }}" == "failure" ]; then
            echo "::error::Documentation path check failed"
            FAILED=true
          fi

          if [ "$FAILED" == "true" ]; then
            echo "::error::Code formatting checks failed. Please run ./scripts/format-all.sh to fix formatting issues."
            exit 1
          fi

          echo "✓ All code formatting checks passed"
