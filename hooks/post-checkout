#!/bin/sh
# Post-checkout hook: Git LFS checkout
# Version: 1.0.0
# Last Updated: 2025-12-04

# Logging setup
REPO_ROOT=$(git rev-parse --show-toplevel)
LOG_DIR="$REPO_ROOT/logs"
LOG_FILE="$LOG_DIR/git-hooks_$(date +%Y-%m-%d).log"
HOSTNAME=$(hostname)
PID=$$

# Create log directory if it doesn't exist
mkdir -p "$LOG_DIR"

# Log function
log_message() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local timezone=$(date +%Z)
    echo "[$timestamp $timezone] [$level] [post-checkout] [$HOSTNAME] [$PID] $message" >> "$LOG_FILE"
}

log_message "INFO" "Post-checkout hook started"

# Git passes three arguments to post-checkout:
# $1: ref of previous HEAD
# $2: ref of new HEAD
# $3: flag indicating whether this was a branch checkout (1) or file checkout (0)

PREV_HEAD=$1
NEW_HEAD=$2
BRANCH_CHECKOUT=$3

log_message "INFO" "Checkout: $PREV_HEAD -> $NEW_HEAD (branch: $BRANCH_CHECKOUT)"

# Run Git LFS post-checkout if available
if command -v git-lfs >/dev/null 2>&1; then
    log_message "INFO" "Running Git LFS post-checkout hook"

    # Only run LFS checkout for branch checkouts, not individual file checkouts
    if [ "$BRANCH_CHECKOUT" = "1" ]; then
        echo "Downloading LFS objects..."
        git lfs post-checkout "$@"
        LFS_EXIT_CODE=$?

        if [ $LFS_EXIT_CODE -ne 0 ]; then
            log_message "WARNING" "Git LFS post-checkout returned exit code $LFS_EXIT_CODE"
            echo "WARNING: Some LFS objects may not have been downloaded properly."
        else
            log_message "INFO" "Git LFS post-checkout completed successfully"
        fi
    else
        log_message "INFO" "File checkout detected, skipping LFS post-checkout"
    fi
else
    log_message "WARNING" "Git LFS not found, skipping LFS post-checkout"
fi

log_message "INFO" "Post-checkout hook completed"
