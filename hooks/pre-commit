#!/bin/sh
# Pre-commit hook: Linting and validation
# Version: 1.0.0
# Last Updated: 2025-11-18

# Logging setup
REPO_ROOT=$(git rev-parse --show-toplevel)
LOG_DIR="$REPO_ROOT/logs"
LOG_FILE="$LOG_DIR/git-hooks_$(date +%Y-%m-%d).log"
HOSTNAME=$(hostname)
PID=$$

# Create log directory if it doesn't exist
mkdir -p "$LOG_DIR"

# Log function
log_message() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local timezone=$(date +%Z)
    echo "[$timestamp $timezone] [$level] [pre-commit] [$HOSTNAME] [$PID] $message" >> "$LOG_FILE"
}

log_message "INFO" "Pre-commit hook started"
echo "Running pre-commit checks..."

# Check if Git LFS is available and validate LFS files
if command -v git-lfs >/dev/null 2>&1; then
    log_message "INFO" "Validating Git LFS configuration"
    # Check if any LFS-tracked files are staged
    LFS_FILES=$(git diff --cached --name-only | grep -E '\.(sql|dump|mp4|zip)$' || true)
    if [ -n "$LFS_FILES" ]; then
        log_message "INFO" "LFS-tracked files detected in commit: $(echo $LFS_FILES | tr '\n' ' ')"
        echo "LFS-tracked files will be handled by Git LFS"
    fi
else
    log_message "WARNING" "Git LFS not found, skipping LFS checks"
fi

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    log_message "INFO" "No staged files to check"
    echo "No staged files to check"
    exit 0
fi

# Track if any checks fail
CHECKS_FAILED=0

# 1. Check for debug statements (exclude documentation and hook files)
log_message "INFO" "Checking for debug statements..."
# Filter out .md files and files in hooks/ directory
CODE_FILES=$(echo "$STAGED_FILES" | grep -v '\.md$' | grep -v '^hooks/' || true)

if [ -n "$CODE_FILES" ]; then
    DEBUG_FILES=$(echo "$CODE_FILES" | xargs grep -l -E "Write-Debug.*TODO|print.*DEBUG|console\.log|debugger;" 2>/dev/null || true)

    if [ -n "$DEBUG_FILES" ]; then
        log_message "ERROR" "Debug statements found in staged files"
        echo "ERROR: Debug statements found in the following files:"
        echo "$DEBUG_FILES"
        echo ""
        echo "Please remove debug statements before committing."
        CHECKS_FAILED=1
    fi
fi

# 2. Check PowerShell files with PSScriptAnalyzer (if pwsh is available)
CHANGED_PS_FILES=$(echo "$STAGED_FILES" | grep '\.ps1$' || true)

if [ -n "$CHANGED_PS_FILES" ]; then
    log_message "INFO" "Found PowerShell files to lint: $(echo $CHANGED_PS_FILES | wc -l) file(s)"

    if command -v pwsh >/dev/null 2>&1; then
        echo "Linting PowerShell files..."
        log_message "INFO" "Running PSScriptAnalyzer on PowerShell files"

        # Create a temporary PowerShell script to run linting
        TEMP_DIR=$(mktemp -d)
        TEMP_PS_SCRIPT="$TEMP_DIR/lint_script.ps1"
        cat > "$TEMP_PS_SCRIPT" <<'PSEOF'
param([string[]]$Files)

$ErrorActionPreference = 'Stop'

# Try to install PSScriptAnalyzer if not present (silently)
if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
    try {
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -ErrorAction SilentlyContinue | Out-Null
    } catch {
        Write-Host "WARNING: Could not install PSScriptAnalyzer. Skipping PowerShell linting."
        exit 0
    }
}

# Import the module
try {
    Import-Module PSScriptAnalyzer -ErrorAction Stop
} catch {
    Write-Host "WARNING: Could not load PSScriptAnalyzer. Skipping PowerShell linting."
    exit 0
}

# Run analysis
$hasErrors = $false
foreach ($file in $Files) {
    if (Test-Path $file) {
        $results = Invoke-ScriptAnalyzer -Path $file -Severity Error,Warning
        if ($results) {
            $hasErrors = $true
            Write-Host "`nIssues found in $file:"
            $results | Format-Table -Property Severity,Line,Message -AutoSize
        }
    }
}

if ($hasErrors) {
    exit 1
}
exit 0
PSEOF

        # Run the PowerShell linting script
        pwsh -NoProfile -ExecutionPolicy Bypass -File "$TEMP_PS_SCRIPT" $CHANGED_PS_FILES
        PS_EXIT_CODE=$?
        rm -rf "$TEMP_DIR"

        if [ $PS_EXIT_CODE -ne 0 ]; then
            log_message "ERROR" "PowerShell linting failed"
            echo "ERROR: PowerShell linting failed. Please fix the issues above before committing."
            CHECKS_FAILED=1
        else
            log_message "INFO" "PowerShell linting passed"
        fi
    else
        log_message "WARNING" "PowerShell (pwsh) not found. Skipping PowerShell linting."
        echo "WARNING: PowerShell (pwsh) not found. Skipping PowerShell linting."
    fi
fi

# 3. Check Python files with pylint (if pylint is available)
CHANGED_PY_FILES=$(echo "$STAGED_FILES" | grep '\.py$' || true)

if [ -n "$CHANGED_PY_FILES" ]; then
    log_message "INFO" "Found Python files to lint: $(echo $CHANGED_PY_FILES | wc -l) file(s)"

    if command -v pylint >/dev/null 2>&1; then
        echo "Linting Python files..."
        log_message "INFO" "Running pylint on Python files"

        # Run pylint with errors-only mode
        pylint $CHANGED_PY_FILES --errors-only --score=no
        PY_EXIT_CODE=$?

        if [ $PY_EXIT_CODE -ne 0 ]; then
            log_message "ERROR" "Python linting failed"
            echo "ERROR: Python linting failed. Please fix the errors above before committing."
            CHECKS_FAILED=1
        else
            log_message "INFO" "Python linting passed"
        fi
    elif command -v python3 >/dev/null 2>&1 || command -v python >/dev/null 2>&1; then
        # If pylint is not installed but Python is, try basic syntax check
        log_message "WARNING" "pylint not found. Running basic Python syntax check..."
        echo "WARNING: pylint not found. Running basic Python syntax check..."

        PYTHON_CMD=$(command -v python3 || command -v python)
        for file in $CHANGED_PY_FILES; do
            $PYTHON_CMD -m py_compile "$file" 2>&1
            if [ $? -ne 0 ]; then
                log_message "ERROR" "Python syntax error in $file"
                echo "ERROR: Python syntax error in $file"
                CHECKS_FAILED=1
            fi
        done

        if [ $CHECKS_FAILED -eq 0 ]; then
            log_message "INFO" "Python syntax check passed"
        fi
    else
        log_message "WARNING" "Python/pylint not found. Skipping Python linting."
        echo "WARNING: Python/pylint not found. Skipping Python linting."
    fi
fi

# 4. Check for large files (>10MB)
log_message "INFO" "Checking for large files..."
LARGE_FILES=$(echo "$STAGED_FILES" | while read file; do
    if [ -f "$file" ]; then
        size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
        if [ "$size" -gt 10485760 ]; then
            echo "$file ($(($size / 1048576))MB)"
        fi
    fi
done)

if [ -n "$LARGE_FILES" ]; then
    log_message "WARNING" "Large files detected in commit"
    echo "WARNING: The following large files (>10MB) are being committed:"
    echo "$LARGE_FILES"
    echo ""
    echo "Consider using Git LFS for large files or verify this is intentional."
fi

# Final result
if [ $CHECKS_FAILED -eq 1 ]; then
    log_message "ERROR" "Pre-commit checks failed"
    echo ""
    echo "Pre-commit checks FAILED!"
    echo "To bypass these checks (not recommended), use: git commit --no-verify"
    exit 1
fi

log_message "INFO" "Pre-commit checks passed"
echo "Pre-commit checks passed!"
exit 0
